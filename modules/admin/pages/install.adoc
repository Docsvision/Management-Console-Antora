= Установка и первоначальная настройка {of-mc}

include::6.1@install-linux::partial$limitation.adoc[]

Без установки и первоначальной настройки {of-mc} не будет функционировать базовый модуль "xref:6.1@workerservice::index.adoc[Служба {ws}]", необходимый для создания групп заданий и отправки почтовых уведомлений.

Требуется установить {wac} и сервис (хранилище) настроек. Установка должна выполняться на одной машине, установка на разные серверы не поддерживается.

[#console]
== Установка {of-mc}

[WARNING]
====
{wac} можно установить на отдельный от {dv} сервер. В таком случае, пользователь, от имени которого запускается {wac}, должен быть добавлен в группу *{dv-web-admin-cns-admins-serv}* на сервере {dv} и на сервере {of-mc}.
====

--
.Чтобы установить {mc}:
:of: {of-mc}
:file: appsettings
:wt: managementconsole
include::6.1@platform:admin:partial$install.adoc[]
+
[source,bash]
----
sudo nano /usr/lib/docsvision/managementconsole/appsettings.json
----
+
[source,json]
----
{
  "SettingsService": {
    "ConnectionString": "ConnectAddress=http://settings.domain.com:5200/api", <.>
    "ApiKey": "SettingsServiceApiKey" <.>
  },
  "ExternalApiService": {
    "ConnectionString": "Address=http://externalapi.domain.com:5300/api", <.>
    "ApiKey": "ExternalApiServiceApiKey" <.>
  },
  "AdministratorGroup": {
    "Users": [
      "account@DOMAIN.COM" <.>
    ]
  }
}
----
<.> Адрес {of-sett-serv}. Формат строки подключения разобран ниже, см. <<conn-string,Строка подключения>>.
<.> Ключ доступа к Сервису настроек (указывается в конфигурационном файле сервиса).
<.> Адрес Сервиса внешнего API. Формат строки подключения разобран ниже, см. <<conn-string,Строка подключения>>.
<.> Ключ доступа к Сервису внешнего API (указывается в конфигурационном файле сервиса).
<.> Пользователи, которым разрешен вход в Консоль управления.
+
Обратите внимание, что домен указывается в верхнем регистре.
+
. Запустите службу Консоли:
+
[source,bash]
----
sudo systemctl start dvconsole
----
--

--
[#sett-serv]
== Установка {of-sett-serv}

.Чтобы установить {sett-serv}:
:of: {of-sett-serv}
:file: appsettings
:wt: settingsservice
include::6.1@platform:admin:partial$install.adoc[]
+
[source,bash]
----
sudo nano /usr/lib/docsvision/settingsservice/appsettings.json
----
+
Основные настройки, которые нужно сделать:
+
[source,json]
----
{
  "ApiKey": "anything", <.>
  "StorageOptions": {
    "Providers": [
      {
        "Alias": "SqlStorage",
        "Default": true,
        "StorageType": "DB-type", <.>
        "StorageOptions": "CONNECTION-STRING", <.>
        "ProviderType": "Hierarchy"
      }
    ]
  }
}
----
<.> Ключ доступа к Сервису настроек.
<.> Тип БД: `MsSql` или `PgSql`.
<.> Строка подключения
+
. Запустите службу сервиса:
+
[source,bash]
----
sudo systemctl start dvsettings
----
--

--
[#external-api]
== Установка сервиса внешнего API

.Чтобы установить Сервис внешнего API:
:of: Сервиса внешнего API
:file: appsettings
:wt: externalapi
include::6.1@platform:admin:partial$install.adoc[]
+
[source,bash]
----
sudo nano /usr/lib/docsvision/externalapi/appsettings.json
----
+
[source,json]
----
{
  "ApiKey": "anything", <.>
  "SettingsService": {
    "ConnectionString": "ConnectAddress=http://settings.domain.com:5200/api", <.>
    "ApiKey": "SettingsServiceApiKey" <.>
  }
}
----
<.> Ключ доступа к Сервису внешнего API (указывается в конфигурационном файле сервиса).
<.> Адрес сервиса настроек.
<.> Ключ доступа к Сервису настроек (указывается в конфигурационном файле сервиса).
+
. Запустите службу сервиса:
+
[source,bash]
----
sudo systemctl start dvexternalapi
----
--

[#package]
== Состав установочного комплекта

. Пакет установки {of-mc}: `{dv} ManagementConsole.msi`.

[#win]
== Установка {of-mc} на Windows

Инсталлятор установит одновременно {wac} и Хранилище (сервис) настроек. Установка должна выполняться на одной машине, установка на разные серверы не поддерживается.

[WARNING]
====
{wac} можно установить на отдельный от {dv} сервер. В таком случае, пользователь, от имени которого запускается {wac}, должен быть добавлен в группу *{dv-web-admin-cns-admins-serv}* на сервере {dv} и на сервере {of-mc}.
====

.Чтобы установить {mc}:
. Откройте пакет установки `{dv} ManagementConsole.msi`.
+
Пользователь, выполняющий установку, получит xref:provide-access.adoc[доступ] к программе {cns} -- будет добавлен в группы *{dv-web-admin-cns-admins-serv}* и *{dv-sett-serv-admins-serv}*.
+
.Установка {of-mc}
image::install-hello.png[Установка {of-mc}]
+
. Нажмите *Далее*, ознакомьтесь с условиями лицензионного соглашения. Подтвердите, что вы согласны с лицензионным соглашением и нажмите *Далее*.
+
.Лицензионное соглашение
image::install-license.png[Лицензионное соглашение]
+
. [[components]]Выберите необходимые компоненты {of-mc}.
+
.Выбор устанавливаемых компонентов
image::install-components.png[Выбор устанавливаемых компонентов]
+
****
Базовые компоненты::
Основные компоненты {of-mc} и сервиса настроек, предоставляющие базовую функциональность.

Компоненты внешнего API::
Компоненты сервиса внешнего REST API Консоли.
//tag::api[]
Данный сервис предоставляет возможность получения сообщений и списка сообщений из системы {dv}.
//end::api[]
****
+
. При необходимости выберите место установки {of-mc}.
+
.Выбор расположения установки
image::install-location.png[Выбор расположения установки]
+
. На следующем шаге будет предложено указать настройки {of-mc}.
+
.Настройки {of-mc}
image::install-settings.png[Настройки {of-mc}]
+
****
Порт для {of-mc}::
Порт для доступа к {of-mc} из браузера по HTTP. По умолчанию `5100`.

Порт для Сервиса настроек::
Порт для подключения Консоли к _{to-sett-serv}_. По умолчанию `5200`.

Порт для Сервиса внешнего API {of-mc}::
Порт для доступа к внешнему REST API Консоли.
Данный сервис предоставляет возможность получения сообщений и списка сообщений из системы {dv}.
+
Соединение между Консолью и сервисом устанавливается от имени авторизованного пользователя Консоли. Сервис также проверяет пользователя на принадлежность к группе *{dv-web-admin-cns-admins-serv}*.

Выберите тип сервера БД из списка::
Microsoft SQL Server или PostgreSQL в зависимости от используемой базы данных.

Строка подключения к базе данных для хранения настроек::
Строка подключения содержит адрес подключения к базе данных для хранения настроек. Вид строки подключения зависит от выбранной базы данных. См. подробнее <<conn-string,ниже>>.
****
+
. Нажмите кнопку *Установить*, чтобы начать установку или кнопку *Назад*, чтобы вернуться на предыдущий шаг.
+
.Продолжить установку или вернуться на предыдущий шаг
image::install-confirm.png[Продолжить установку или вернуться на предыдущий шаг]
+
. Нажмите кнопку *Готово*, чтобы закрыть мастер установки.

После установки на сервере необходимо настроить группу пользователей, имеющих право работать с Консолью управления. Чтобы предоставить доступ к Консоли управления, выполните инструкцию в пункте xref:provide-access.adoc[].

[#conn-string]
== Строка подключения к базе данных для хранения настроек

Строка подключения содержит адрес подключения к базе данных для хранения настроек. Вид строки подключения зависит от выбранной базы данных.

NOTE: Для _{of-sett-serv}_ рекомендуется использовать отдельную базу данных.

//tag::mssql[]
Для Microsoft SQL Server: `Data Source=Адрес-сервера-баз-данных;Initial Catalog=Название-БД-Службы-фоновых-операций;Integrated Security=False;User ID=Имя-пользователя-БД;Password=Пароль-пользователя-БД`.

* `Data Source` -- адрес сервера SQL для подключения к БД. В качестве `Data Source` может быть указан экземпляр SQL-сервера, например так: `Data Source=DVDatabse\Server1`.
* `Название-БД-Службы-фоновых-операций` -- псевдоним базы данных.
* `Integrated Security` -- задает логическое значение, определяющее способ проверки подлинности:
** `False` -- при подключении в строке должны быть указаны идентификатор пользователя и пароль.
** `True` -- при подключении будут использованы учетные данные текущей учетной записи Windows.
* `Имя-пользователя-БД` -- учётная запись пользователя для подключения к БД.
* `Пароль-пользователя-БД` -- пароль учётной записи для подключения к БД.
* `TrustServerCertificate=True` -- подробнее про настройку см. <<cert,особенности настройки сертификата>>.

Если строке подключения введены корректные данные, при запуске _{of-sett-serv}_ будет создана новая или обновлена существующая БД.
//end::mssql[]

//tag::pgsql[]
Для PostgreSQL: `host=Адрес-сервера-баз данных;Port=SQL-порт;database=Название-БД-{of-sm};Username=Имя-пользователя-БД;Password=Пароль-пользователя-БД`.

* `Адрес-сервера-баз данных` -- адрес сервера SQL для подключения к БД.
* `SQL-порт` -- порт SQL-сервера.
* `Название-БД-{of-sm}` -- псевдоним базы данных.
* `Имя-пользователя-БД` -- учётная запись пользователя для подключения к БД.
* `Пароль-пользователя-БД` -- пароль учётной записи для подключения к БД.
//end::pgsql[]

[#configuration]
== Настройка {of-mc}

Установка приносит настройки, которые не зависят от машины где развертывается {mc}.
После установки создаётся файл настроек {of-mc} `appsettings.json` По умолчанию в файле указываются настройки для BackOffice.
В `.json` файле настроек содержатся: имена типов реализаций подключаемых к Службе {ws}, настройки их сопоставления, роли обработки задач BackOffice, а также настройки самой Службы {ws} (включая очереди, фабрики и прочие).

После установки {mc} требуется выполнить первичную настройку Консоли и  _Службы {ws}_. Если проигнорировать первичную настройку:

* Не будут создаваться и отправляться группы заданий.
* Не будут отправляться почтовые уведомления исполнителям.

См. подробнее "xref:user:initial-configuration.adoc[]".

// tag::cert[]
[#cert]
== Особенности настройки сертификата

Настройка актуальная только для {mssql}, для {pgsql} дополнительных настроек не требуется.
// end::cert[]

Поскольку _{mc}_ работает под управлением .NET 6, компонент `System.Data.SqlClient` был заменён на `Microsoft.Data.SqlClient` как более перспективный с точки зрения развития.

В этом компоненте значение `Encrypt` по умолчанию https://learn.microsoft.com/ru-ru/sql/connect/ado-net/introduction-microsoft-data-sqlclient-namespace?view=sql-server-ver15#encrypt-default-value-set-to-true[изменилось].
// tag::cert[]
По умолчанию провайдер считает соединение с БД защищённым.

Если соединение не защищено (т.е. не настроен сертификат на уровне БД, используется самозаверенный или недействительный сертификат), необходимо в строке соединения указывать `TrustServerCertificate = true`, это сообщит провайдеру, что серверу можно доверять.

Если есть потребность защитить соединение, настройте {mssql} сервер в соответствии с xref:mgmtconsole:admin:create-cert.adoc[инструкцией].
// end::cert[]

[#deletion]
== Удаление {of-mc}

Чтобы удалить {mc}, запустите инсталлятор в режиме удаления.

Созданные группы и службы будут удалены, _{sett-serv}_ станет недоступно.
