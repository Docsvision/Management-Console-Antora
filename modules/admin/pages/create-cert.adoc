= Создание доверенного сертификата для подключения к БД

[#iis]
== Создание сертификата через IIS

include::webclient:admin:preview-r7.adoc[tags=cert-iis]
+
Сертификат также можно сгенерировать другими способами.
+
.Главные требование к SSL-сертификату на {mssql} сервере:
* Название сертификата должно быть равно полному имени сервера равный DNS имени сервера.
* В качестве цели использования необходимо указывать "Серверная аутентификация".
+
. Импортируйте сертификат на сервере с {mssql} и поместите его в _Личное хранилище_.
+
.Сертификат в личном хранилище
image::cert-store.png[Сертификат в личном хранилище]
+
. Запустите _Диспетчер конфигурации SQL Server_. В категории сетевая конфигурация SQL Server найдите раздел _Протоколы для "имя-сервера"_.
. В свойствах раздела _Протоколы для "имя-сервера"_ выберите вкладку _Сертификат_ и укажите импортированный сертификат.
. Перейдите на вкладку _Флаги_ и отметьте флаг _ForceEncryption_ в значение *Да*.
. Чтобы настройки применились, перезапустите службу экземпляра сервера {mssql}.
+
****
Для этого необходимо разрешить учётной записи "NT Service\MSSQLSERVER" права на чтение сертификата. Если этого не сделать, сиквел не запустится и в журнал Windows будут записаны ошибки.

.Разрешения на чтение сертификата
image::cert-read.png[Разрешения на чтение сертификата]
****

[#openssl]
== Создание сертификата с помощью OpenSSL

Другой способ создать сертификат -- использовать утилиту [OpenSSL](https://slproweb.com/products/Win32OpenSSL.html).

. Создайте сертификат следующей командой:
+
  openssl req -x509 -newkey rsa:4096 -sha256 -keyout c:\out\authservice.key -out c:\out\authservice.crt -subj "/CN=http://docsvision.com" -days 600
+
Где `c:\out\authservice` -- место сохранения сертификата.
+
В процессе создания сертификата будет предложено задать пароль для сертификата.
+
. Экспортируйте сертификат, выполнив следующую команду:
+
  openssl pkcs12 -export -name "http://webservice.com" -out c:\out\authservice.pfx -inkey c:\out\authservice.key -in c:\out\authservice.crt
+
В `c:\out\authservice` укажите путь для сохранения сертификата. Также замените `name` на имя сервера {mssql}.
+
Утилита запросит пароль на сертификат и на файл `.pfx`.
